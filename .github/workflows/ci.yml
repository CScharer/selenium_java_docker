name: Selenium Grid CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write  # Required for GitHub Pages deployment

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx2048m

jobs:
  build-and-compile:
    name: Build & Compile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile project
        run: ./mvnw clean compile test-compile

      - name: Upload compiled classes
        uses: actions/upload-artifact@v4
        with:
          name: compiled-classes
          path: target/
          retention-days: 1

  smoke-tests:
    name: Smoke Tests (Fast Check)
    runs-on: ubuntu-latest
    needs: build-and-compile

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444
          - 4442:4442
          - 4443:4443

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: >-
          --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          echo "Waiting for Grid Hub..."
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          echo "Grid Hub is up!"
          
          echo "Waiting for Chrome node to register..."
          sleep 10
          
          for i in {1..20}; do
            NODES=$(curl -sf http://localhost:4444/wd/hub/status | jq -r '.value.nodes | length' 2>/dev/null || echo "0")
            echo "  Attempt $i: $NODES nodes registered"
            if [ "$NODES" -gt "0" ]; then
              echo "âœ… Grid is ready with $NODES node(s)!"
              break
            fi
            sleep 2
          done

      - name: Verify Grid is ready
        run: |
          echo "Final Grid readiness check..."
          GRID_STATUS=$(curl -sf http://localhost:4444/wd/hub/status)
          echo "$GRID_STATUS" | jq '.'
          
          READY=$(echo "$GRID_STATUS" | jq -r '.value.ready')
          NODES=$(echo "$GRID_STATUS" | jq -r '.value.nodes | length')
          
          echo "Grid Ready: $READY"
          echo "Nodes Available: $NODES"
          
          if [ "$READY" != "true" ] || [ "$NODES" -eq "0" ]; then
            echo "âŒ Grid is not ready! Aborting smoke tests."
            exit 1
          fi
          
          echo "âœ… Grid is fully ready with $NODES node(s)"
      
      - name: Run Smoke Tests
        timeout-minutes: 5
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
        run: |
          echo "Starting smoke tests..."
          echo "Grid URL: $SELENIUM_REMOTE_URL"
          
          ./mvnw test -DsuiteXmlFile=testng-smoke-suite.xml
          
          echo "Smoke tests completed"

      - name: Verify smoke results
        if: always()
        run: |
          echo "ðŸ”¥ Smoke Test Results:"
          echo "  Test XML files: $(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null | wc -l)"
          
          TOTAL_FAILURES=0
          TOTAL_ERRORS=0
          
          if [ -d "target/surefire-reports" ]; then
            echo ""
            echo "Surefire Reports:"
            ls -la target/surefire-reports/
            echo ""
            
            for xml in target/surefire-reports/TEST-*.xml; do
              if [ -f "$xml" ]; then
                echo "Report: $xml"
                
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml" | head -1 || echo "0")
                ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml" | head -1 || echo "0")
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml" | head -1 || echo "0")
                
                echo "  Tests: $TESTS, Failures: $FAILURES, Errors: $ERRORS"
                
                TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURES))
                TOTAL_ERRORS=$((TOTAL_ERRORS + ERRORS))
              fi
            done
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Total Failures: $TOTAL_FAILURES"
            echo "Total Errors: $TOTAL_ERRORS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            if [ "$TOTAL_FAILURES" -gt "0" ] || [ "$TOTAL_ERRORS" -gt "0" ]; then
              echo ""
              echo "âŒ SMOKE TESTS FAILED!"
              echo "   Failures: $TOTAL_FAILURES"
              echo "   Errors: $TOTAL_ERRORS"
              exit 1
            else
              echo ""
              echo "âœ… ALL SMOKE TESTS PASSED!"
            fi
          else
            echo "âš ï¸  No surefire-reports directory found"
            exit 1
          fi

  selenium-grid-tests:
    name: Grid Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: [build-and-compile, smoke-tests]

    strategy:
      matrix:
        browser: [chrome, firefox]
      fail-fast: false

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444
          - 4442:4442
          - 4443:4443

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: >-
          --shm-size=2gb

      firefox-node:
        image: selenium/node-firefox:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: >-
          --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          echo "Waiting for Grid Hub..."
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          echo "Grid Hub is up!"
          
          echo "Waiting for browser nodes to register..."
          sleep 10
          
          echo "Checking Grid status..."
          curl -sf http://localhost:4444/wd/hub/status | jq '.' || true
          
          echo "Verifying nodes are available..."
          for i in {1..30}; do
            NODES=$(curl -sf http://localhost:4444/wd/hub/status | jq -r '.value.nodes | length' 2>/dev/null || echo "0")
            echo "  Attempt $i: $NODES nodes registered"
            if [ "$NODES" -gt "0" ]; then
              echo "âœ… Grid is ready with $NODES node(s)!"
              curl -sf http://localhost:4444/wd/hub/status | jq '.value.nodes[] | {id: .id, availability: .availability, maxSessions: .maxSessions}' || true
              break
            fi
            if [ "$i" -eq "30" ]; then
              echo "âŒ ERROR: No nodes registered after 60 seconds!"
              echo "Grid will not be functional. Failing job."
              exit 1
            fi
            sleep 2
          done
      
      - name: Verify Grid is ready
        run: |
          echo "Final Grid readiness check..."
          GRID_STATUS=$(curl -sf http://localhost:4444/wd/hub/status)
          echo "$GRID_STATUS" | jq '.'
          
          READY=$(echo "$GRID_STATUS" | jq -r '.value.ready')
          NODES=$(echo "$GRID_STATUS" | jq -r '.value.nodes | length')
          
          echo "Grid Ready: $READY"
          echo "Nodes Available: $NODES"
          
          if [ "$READY" != "true" ] || [ "$NODES" -eq "0" ]; then
            echo "âŒ Grid is not ready! Aborting tests."
            exit 1
          fi
          
          echo "âœ… Grid is fully ready with $NODES node(s)"

      - name: Run Grid Tests
        timeout-minutes: 15
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          BROWSER: ${{ matrix.browser }}
        run: |
          echo "Starting Grid tests with ${{ matrix.browser }}..."
          ./mvnw test -DsuiteXmlFile=testng-ci-suite.xml
          echo "Grid tests completed"

      - name: Verify test results
        if: always()
        run: |
          echo "ðŸ“Š Test Results Summary (${{ matrix.browser }}):"
          echo "  Surefire reports: $(find target/surefire-reports -name "*.xml" 2>/dev/null | wc -l) files"
          echo "  Allure results: $(find target/allure-results -name "*-result.json" 2>/dev/null | wc -l) tests"
          echo "  Screenshots: $(find target/allure-results -name "*.png" 2>/dev/null | wc -l) images"
          echo "  Total Allure files: $(find target/allure-results -type f 2>/dev/null | wc -l)"
          
          TOTAL_FAILURES=0
          TOTAL_ERRORS=0
          TOTAL_TESTS=0
          
          if [ -d "target/surefire-reports" ]; then
            echo ""
            echo "Test Execution Summary:"
            for xml in target/surefire-reports/TEST-*.xml; do
              if [ -f "$xml" ]; then
                echo "  $(basename $xml):"
                
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml" | head -1 || echo "0")
                ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml" | head -1 || echo "0")
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml" | head -1 || echo "0")
                
                echo "    Tests: $TESTS, Failures: $FAILURES, Errors: $ERRORS"
                
                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURES))
                TOTAL_ERRORS=$((TOTAL_ERRORS + ERRORS))
              fi
            done
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Browser: ${{ matrix.browser }}"
            echo "Total Tests: $TOTAL_TESTS"
            echo "Total Failures: $TOTAL_FAILURES"
            echo "Total Errors: $TOTAL_ERRORS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            if [ "$TOTAL_FAILURES" -gt "0" ] || [ "$TOTAL_ERRORS" -gt "0" ]; then
              echo ""
              echo "âŒ GRID TESTS FAILED (${{ matrix.browser }})!"
              echo "   Failures: $TOTAL_FAILURES"
              echo "   Errors: $TOTAL_ERRORS"
              exit 1
            else
              echo ""
              echo "âœ… ALL GRID TESTS PASSED (${{ matrix.browser }})!"
            fi
          else
            echo "âš ï¸  No surefire-reports directory found"
            exit 1
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: target/screenshots/
          retention-days: 7

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: selenium-grid-tests
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: test-results
      
      - name: Prepare Allure results
        if: always()
        run: |
          echo "ðŸ“Š Merging Allure results from all browsers..."
          mkdir -p allure-results
          
          # Copy all result files directly (works regardless of directory structure)
          find test-results -name "*-result.json" -exec cp {} allure-results/ \; 2>&1 || true
          find test-results -name "*-container.json" -exec cp {} allure-results/ \; 2>&1 || true
          find test-results -name "*-attachment.*" -exec cp {} allure-results/ \; 2>&1 || true
          
          echo "âœ… Merge complete!"
          echo "  JSON results: $(find allure-results -name "*-result.json" | wc -l)"
          echo "  Screenshots: $(find allure-results -name "*.png" | wc -l)"
          echo "  Total files: $(find allure-results -type f | wc -l)"
      
      - name: Install Allure CLI
        if: always()
        run: |
          echo "Installing Allure CLI..."
          wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version
          echo "âœ… Allure CLI installed"
      
      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report..."
          mkdir -p allure-results/history
          allure generate allure-results --clean -o allure-report
          echo "âœ… Report generated successfully!"
          ls -la allure-report/
      
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30
      
      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      
      - name: Report Info
        if: always()
        run: |
          echo "ðŸ“Š Allure Report Generated!"
          echo ""
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ðŸŒ View online report at:"
            echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            echo ""
          fi
          echo "ðŸ“¥ Or download the 'allure-report' artifact:"
          echo "1. Go to this workflow run"
          echo "2. Scroll to Artifacts section"
          echo "3. Click 'allure-report' to download"
          echo "4. Extract and open index.html"

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build-and-compile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle
        run: |
          echo "Running Checkstyle..."
          ./mvnw checkstyle:check
          echo "âœ… Checkstyle passed: target/checkstyle-result.xml"

      - name: Run SpotBugs
        run: |
          echo "Running SpotBugs..."
          ./mvnw spotbugs:check
          echo "âœ… SpotBugs passed: target/spotbugsXml.xml"
        continue-on-error: true

      - name: Run PMD
        run: |
          echo "Running PMD..."
          ./mvnw pmd:check
          echo "âœ… PMD passed: target/pmd.xml"
        continue-on-error: true

      - name: Run dependency analysis
        run: |
          echo "Running dependency analysis..."
          ./mvnw dependency:analyze
        continue-on-error: true

      - name: Upload code quality reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            target/checkstyle-result.xml
            target/spotbugsXml.xml
            target/pmd.xml
            target/site/
          retention-days: 7
          if-no-files-found: ignore

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker test container
        run: docker compose build tests

      - name: Verify container can run
        run: docker run --rm selenium_java_docker-tests:latest ./mvnw --version

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [selenium-grid-tests, allure-report]
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: test-results

      - name: Create test summary
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results by Browser" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for browser in chrome firefox; do
            if [ -d "test-results/test-results-$browser" ]; then
              echo "#### ${browser^} Browser" >> $GITHUB_STEP_SUMMARY

              # Count test results
              total=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "tests=" {} \; | head -1 | sed 's/.*tests="\([0-9]*\)".*/\1/' || echo "0")
              failures=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "failures=" {} \; | head -1 | sed 's/.*failures="\([0-9]*\)".*/\1/' || echo "0")
              errors=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "errors=" {} \; | head -1 | sed 's/.*errors="\([0-9]*\)".*/\1/' || echo "0")

              if [ "$failures" = "0" ] && [ "$errors" = "0" ]; then
                echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
              fi

              echo "- Tests: $total" >> $GITHUB_STEP_SUMMARY
              echo "- Failures: $failures" >> $GITHUB_STEP_SUMMARY
              echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "### ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "Download the 'allure-report' artifact to view detailed test results" >> $GITHUB_STEP_SUMMARY
