name: Selenium Grid CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write  # Required for GitHub Pages deployment

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx2048m

jobs:
  build-and-compile:
    name: Build & Compile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile project
        run: ./mvnw clean compile test-compile

      - name: Upload compiled classes
        uses: actions/upload-artifact@v4
        with:
          name: compiled-classes
          path: target/
          retention-days: 1

  selenium-grid-tests:
    name: Grid Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: build-and-compile

    strategy:
      matrix:
        browser: [chrome, firefox]
      fail-fast: false

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444
        options: >-
          --health-cmd "curl -f http://localhost:4444/wd/hub/status || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
        options: >-
          --shm-size=2gb

      firefox-node:
        image: selenium/node-firefox:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
        options: >-
          --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          echo "Grid is ready!"

      - name: Verify TestNG Suite Configuration
        run: |
          echo "=== TestNG Suite File ==="
          cat src/test/resources/testng-ci-suite.xml
          echo ""
          echo "=== Checking for Allure Listener ==="
          grep -i "AllureTestNg" src/test/resources/testng-ci-suite.xml && echo "âœ… Listener found in suite!" || echo "âŒ Listener NOT found!"
          echo ""
          echo "=== ServiceLoader File ==="
          cat src/test/resources/META-INF/services/org.testng.ITestNGListener || echo "âŒ ServiceLoader file missing"

      - name: Run Grid Tests
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          BROWSER: ${{ matrix.browser }}
        run: |
          ./mvnw test -DsuiteXmlFile=testng-ci-suite.xml

      - name: Debug test results
        if: always()
        run: |
          echo "=== Checking for test results ==="
          ls -la target/ || echo "No target directory"
          echo ""
          echo "=== Surefire Reports ==="
          ls -la target/surefire-reports/ || echo "No surefire-reports"
          echo ""
          echo "=== Allure Results Directory ==="
          ls -la target/allure-results/ || echo "No allure-results"
          echo ""
          echo "=== Allure JSON Files ==="
          find target -name "*-result.json" -ls || echo "No Allure JSON files"
          echo ""
          echo "=== Allure PNG Files ==="
          find target -name "*.png" -ls || echo "No PNG files"
          echo ""
          echo "=== Total Allure File Count ==="
          find target/allure-results -type f 2>/dev/null | wc -l || echo "0"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: target/screenshots/
          retention-days: 7

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: selenium-grid-tests
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: test-results
      
      - name: Prepare Allure results
        if: always()
        run: |
          echo "Checking downloaded artifacts..."
          ls -la test-results/
          
          echo "Merging allure-results from all browsers..."
          mkdir -p allure-results
          find test-results -name "allure-results" -type d -exec cp -r {}/* allure-results/ \; || true
          
          echo "Allure results after merge:"
          ls -la allure-results/
          find allure-results -type f | head -20
      
      - name: Install Allure CLI
        if: always()
        run: |
          echo "Installing Allure CLI..."
          wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version
          echo "âœ… Allure CLI installed"
      
      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report..."
          mkdir -p allure-results/history
          allure generate allure-results --clean -o allure-report
          echo "âœ… Report generated successfully!"
          ls -la allure-report/
      
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30
      
      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      
      - name: Report Info
        if: always()
        run: |
          echo "ðŸ“Š Allure Report Generated!"
          echo ""
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ðŸŒ View online report at:"
            echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            echo ""
          fi
          echo "ðŸ“¥ Or download the 'allure-report' artifact:"
          echo "1. Go to this workflow run"
          echo "2. Scroll to Artifacts section"
          echo "3. Click 'allure-report' to download"
          echo "4. Extract and open index.html"

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build-and-compile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run dependency analysis
        run: ./mvnw dependency:analyze
        continue-on-error: true

      - name: Check for dependency vulnerabilities
        run: ./mvnw dependency:tree
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker test container
        run: docker compose build tests

      - name: Verify container can run
        run: docker run --rm selenium_java_docker-tests:latest ./mvnw --version

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [selenium-grid-tests, allure-report]
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: test-results

      - name: Create test summary
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results by Browser" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for browser in chrome firefox; do
            if [ -d "test-results/test-results-$browser" ]; then
              echo "#### ${browser^} Browser" >> $GITHUB_STEP_SUMMARY

              # Count test results
              total=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "tests=" {} \; | head -1 | sed 's/.*tests="\([0-9]*\)".*/\1/' || echo "0")
              failures=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "failures=" {} \; | head -1 | sed 's/.*failures="\([0-9]*\)".*/\1/' || echo "0")
              errors=$(find "test-results/test-results-$browser" -name "TEST-*.xml" -exec grep -h "errors=" {} \; | head -1 | sed 's/.*errors="\([0-9]*\)".*/\1/' || echo "0")

              if [ "$failures" = "0" ] && [ "$errors" = "0" ]; then
                echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
              fi

              echo "- Tests: $total" >> $GITHUB_STEP_SUMMARY
              echo "- Failures: $failures" >> $GITHUB_STEP_SUMMARY
              echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "### ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "Download the 'allure-report' artifact to view detailed test results" >> $GITHUB_STEP_SUMMARY
