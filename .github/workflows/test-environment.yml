name: Test Single Environment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test (dev, test, prod)'
        required: true
        type: string
      test_suite:
        description: 'Test suite to run (smoke, ci, extended, all)'
        required: false
        type: string
        default: 'smoke'
      base_url:
        description: 'Base URL for the environment'
        required: true
        type: string

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx2048m

jobs:
  smoke-tests:
    name: Smoke Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444
          - 4442:4442
          - 4443:4443

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          echo "â³ Waiting for Grid..."
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          sleep 5
          echo "âœ… Grid ready!"

      - name: Run Smoke Tests
        timeout-minutes: 5
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”¥ Smoke Tests - ${{ inputs.environment }} Environment"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          mkdir -p target/allure-results
          cat > target/allure-results/environment.properties << EOF
          Environment=${{ inputs.environment }}
          Test.Suite=smoke
          Base.URL=${{ inputs.base_url }}
          Browser=Chrome
          Selenium.Hub=localhost:4444
          Execution.Type=CI/CD
          EOF

          ./mvnw test \
            -Dtest.environment=${{ inputs.environment }} \
            -DsuiteXmlFile=testng-smoke-suite.xml

      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7

  grid-tests:
    name: Grid Tests - ${{ matrix.browser }} (${{ inputs.environment }})
    runs-on: ubuntu-latest
    # No dependencies - runs in PARALLEL with smoke, mobile, and responsive

    strategy:
      matrix:
        browser: [chrome, firefox]
      fail-fast: false

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444
          - 4442:4442
          - 4443:4443

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: --shm-size=2gb

      firefox-node:
        image: selenium/node-firefox:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 5
        options: --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          echo "â³ Waiting for Grid..."
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          sleep 10
          echo "âœ… Grid ready!"

      - name: Run Grid Tests
        timeout-minutes: 15
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          BROWSER: ${{ matrix.browser }}
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Grid Tests - ${{ matrix.browser }} - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "Browser: ${{ matrix.browser }}"
          echo "URL: ${{ inputs.base_url }}"
          echo "Suite: ${{ inputs.test_suite }}"
          echo ""

          # Create Allure environment properties file
          mkdir -p target/allure-results
          cat > target/allure-results/environment.properties << EOF
          Environment=${{ inputs.environment }}
          Test.Suite=${{ inputs.test_suite }}
          Base.URL=${{ inputs.base_url }}
          Browser=${{ matrix.browser }}
          Selenium.Hub=localhost:4444
          Execution.Type=CI/CD
          Grid.Type=Selenium Grid
          EOF

          ./mvnw test \
            -Dtest.environment=${{ inputs.environment }} \
            -Dbrowser=${{ matrix.browser }} \
            -DsuiteXmlFile=testng-${{ inputs.test_suite }}-suite.xml

      - name: Upload Grid Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grid-results-${{ matrix.browser }}-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7

  mobile-browser-tests:
    name: Mobile Browser Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    # No dependencies - runs in PARALLEL with smoke, grid, and responsive

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 2
        options: --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          sleep 5
          echo "âœ… Grid ready!"

      - name: Run Mobile Browser Tests
        timeout-minutes: 10
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“± Mobile Browser Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          mkdir -p target/allure-results
          cat > target/allure-results/environment.properties << EOF
          Environment=${{ inputs.environment }}
          Test.Suite=mobile-browser
          Base.URL=${{ inputs.base_url }}
          Browser=Chrome Mobile
          Selenium.Hub=localhost:4444
          Execution.Type=CI/CD
          Device.Type=Mobile Viewport
          EOF

          ./mvnw test \
            -Dtest.environment=${{ inputs.environment }} \
            -DsuiteXmlFile=testng-mobile-browser-suite.xml

      - name: Upload Mobile Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7

  responsive-design-tests:
    name: Responsive Design Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    # No dependencies - runs in PARALLEL with smoke, grid, and mobile

    services:
      selenium-hub:
        image: selenium/hub:4.26.0
        ports:
          - 4444:4444

      chrome-node:
        image: selenium/node-chrome:4.26.0
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
          SE_NODE_MAX_SESSIONS: 2
        options: --shm-size=2gb

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status; do sleep 2; done'
          sleep 5
          echo "âœ… Grid ready!"

      - name: Run Responsive Design Tests
        timeout-minutes: 10
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ Responsive Design Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          mkdir -p target/allure-results
          cat > target/allure-results/environment.properties << EOF
          Environment=${{ inputs.environment }}
          Test.Suite=responsive
          Base.URL=${{ inputs.base_url }}
          Browser=Chrome
          Selenium.Hub=localhost:4444
          Execution.Type=CI/CD
          Screen.Sizes=Desktop, Tablet, Mobile
          EOF

          ./mvnw test \
            -Dtest.environment=${{ inputs.environment }} \
            -DsuiteXmlFile=testng-responsive-suite.xml

      - name: Upload Responsive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: responsive-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7

  environment-allure-report:
    name: Allure Report (${{ inputs.environment }})
    runs-on: ubuntu-latest
    needs: [smoke-tests, grid-tests, mobile-browser-tests, responsive-design-tests]  # Wait for ALL tests
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download all test results for this environment
        uses: actions/download-artifact@v6
        with:
          pattern: "*-results-${{ inputs.environment }}"
          path: test-results

      - name: Prepare Allure results
        if: always()
        run: |
          echo "ðŸ“Š Merging Allure results for ${{ inputs.environment }} environment..."
          mkdir -p allure-results

          find test-results -name "*-result.json" -exec cp {} allure-results/ \; 2>&1 || true
          find test-results -name "*-container.json" -exec cp {} allure-results/ \; 2>&1 || true
          find test-results -name "*-attachment.*" -exec cp {} allure-results/ \; 2>&1 || true

          echo "âœ… Merge complete for ${{ inputs.environment }}!"
          echo "  Results: $(find allure-results -name "*-result.json" | wc -l)"
          echo "  Screenshots: $(find allure-results -name "*.png" | wc -l)"

      - name: Install Allure CLI
        if: always()
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report for ${{ inputs.environment }}..."
          allure generate allure-results --clean -o allure-report-${{ inputs.environment }}
          echo "âœ… Report generated!"

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-${{ inputs.environment }}
          path: allure-report-${{ inputs.environment }}/
          retention-days: 30

  environment-test-summary:
    name: Test Summary (${{ inputs.environment }})
    runs-on: ubuntu-latest
    needs: [smoke-tests, grid-tests, mobile-browser-tests, responsive-design-tests]  # Wait for ALL tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v6
        with:
          pattern: "*-results-${{ inputs.environment }}"
          path: test-results

      - name: Create test summary
        run: |
          echo "## ðŸ§ª Test Results - ${{ inputs.environment }} Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL**: ${{ inputs.base_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite**: ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse test results
          TOTAL_TESTS=0
          TOTAL_FAILURES=0
          TOTAL_ERRORS=0

          for xml_file in test-results/**/TEST-*.xml; do
            if [ -f "$xml_file" ]; then
              tests=$(grep -oP 'tests="\K[0-9]+' "$xml_file" | head -1 || echo "0")
              failures=$(grep -oP 'failures="\K[0-9]+' "$xml_file" | head -1 || echo "0")
              errors=$(grep -oP 'errors="\K[0-9]+' "$xml_file" | head -1 || echo "0")

              TOTAL_TESTS=$((TOTAL_TESTS + ${tests:-0}))
              TOTAL_FAILURES=$((TOTAL_FAILURES + ${failures:-0}))
              TOTAL_ERRORS=$((TOTAL_ERRORS + ${errors:-0}))
            fi
          done

          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Total Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: $((TOTAL_TESTS - TOTAL_FAILURES - TOTAL_ERRORS))" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $TOTAL_FAILURES" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: $TOTAL_ERRORS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL_FAILURES" -gt "0" ] || [ "$TOTAL_ERRORS" -gt "0" ]; then
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
          fi
