# CJS QA Automation Framework - Docker Compose
# Selenium Grid setup with Chrome, Firefox, and Edge nodes
# Note: Uses seleniarm images for Apple Silicon (M1/M2/M3) compatibility

services:
  # Selenium Hub - Central point for test execution
  selenium-hub:
    image: seleniarm/hub:latest
    container_name: selenium-hub
    platform: linux/arm64
    ports:
      - "4444:4444"      # Selenium Grid UI
      - "4442:4442"      # Event bus publish port
      - "4443:4443"      # Event bus subscribe port
    environment:
      - GRID_MAX_SESSION=10
      - GRID_BROWSER_TIMEOUT=300
      - GRID_TIMEOUT=300
      - SE_SESSION_REQUEST_TIMEOUT=300
      - SE_SESSION_RETRY_INTERVAL=5
    networks:
      - selenium-grid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Chrome Node - 2 instances for parallel execution
  chrome-node-1:
    image: seleniarm/node-chromium:latest
    container_name: chrome-node-1
    platform: linux/arm64
    depends_on:
      selenium-hub:
        condition: service_healthy
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_VNC_NO_PASSWORD=1
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
    ports:
      - "5900:5900"      # VNC port for debugging
      - "7900:7900"      # noVNC web interface
    volumes:
      - ./videos:/videos
    shm_size: 2gb
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    networks:
      - selenium-grid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  chrome-node-2:
    image: seleniarm/node-chromium:latest
    container_name: chrome-node-2
    platform: linux/arm64
    depends_on:
      selenium-hub:
        condition: service_healthy
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_VNC_NO_PASSWORD=1
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
    ports:
      - "5901:5900"      # VNC port for debugging
      - "7901:7900"      # noVNC web interface
    shm_size: 2gb
    networks:
      - selenium-grid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Firefox Node - Disabled until framework changes are complete
  # firefox-node:
  #   image: seleniarm/node-firefox:latest
  #   container_name: firefox-node
  #   platform: linux/arm64
  #   depends_on:
  #     selenium-hub:
  #       condition: service_healthy
  #   environment:
  #     - SE_EVENT_BUS_HOST=selenium-hub
  #     - SE_EVENT_BUS_PUBLISH_PORT=4442
  #     - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
  #     - SE_NODE_MAX_SESSIONS=5
  #     - SE_NODE_SESSION_TIMEOUT=300
  #     - SE_VNC_NO_PASSWORD=1
  #     - SE_SCREEN_WIDTH=1920
  #     - SE_SCREEN_HEIGHT=1080
  #   ports:
  #     - "5902:5900"      # VNC port for debugging
  #     - "7902:7900"      # noVNC web interface
  #   shm_size: 2gb
  #   networks:
  #     - selenium-grid
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5555/status"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Edge Node (Note: Not available for ARM, using Chromium instead)
  edge-node:
    image: seleniarm/node-chromium:latest
    container_name: edge-node
    platform: linux/arm64
    depends_on:
      selenium-hub:
        condition: service_healthy
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_VNC_NO_PASSWORD=1
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
    ports:
      - "5903:5900"      # VNC port for debugging
      - "7903:7900"      # noVNC web interface
    shm_size: 2gb
    networks:
      - selenium-grid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Test Execution Container
  tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cjs-qa-tests
    depends_on:
      selenium-hub:
        condition: service_healthy
      chrome-node-1:
        condition: service_healthy
      chrome-node-2:
        condition: service_healthy
      # firefox-node:  # Disabled until framework changes are complete
      #   condition: service_healthy
      edge-node:
        condition: service_healthy
    environment:
      - SELENIUM_REMOTE_URL=http://selenium-hub:4444/wd/hub
      - BROWSER=${BROWSER:-chrome}
      - HEADLESS=${HEADLESS:-false}
      - PARALLEL_THREADS=${PARALLEL_THREADS:-5}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account-key.json
    volumes:
      # Mount source code for Google Java Format changes to persist
      - ./src:/app/src
      # Mount Checkstyle config files for local validation
      - ./checkstyle-custom.xml:/app/checkstyle-custom.xml:ro
      - ./checkstyle-suppressions.xml:/app/checkstyle-suppressions.xml:ro
      # Mount test results for access from host
      - ./target/surefire-reports:/app/target/surefire-reports
      - ./target/cucumber-reports:/app/target/cucumber-reports
      - ./target/allure-results:/app/target/allure-results
      # Mount Google Cloud credentials if needed
      - ~/.config/gcloud:/app/credentials:ro
    networks:
      - selenium-grid
    # Override command to run specific tests
    # command: ["-Dtest=Scenarios#Google"]

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    platform: linux/arm64
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - selenium-grid
    restart: unless-stopped

  # Grafana - Visualization Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    platform: linux/arm64
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - selenium-grid
    depends_on:
      - prometheus
    restart: unless-stopped

networks:
  selenium-grid:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:

# Usage:
# 1. Start Selenium Grid only:
#    docker-compose up -d selenium-hub chrome-node-1 chrome-node-2 edge-node
#    # Note: firefox-node disabled until framework changes are complete
#
# 2. Run tests:
#    docker-compose up tests
#
# 3. Run specific test:
#    docker-compose run --rm tests -Dtest=Scenarios#Google
#
# 4. View Selenium Grid Console:
#    http://localhost:4444
#
# 5. Debug with VNC (password: secret):
#    Chrome 1: vnc://localhost:5900
#    Chrome 2: vnc://localhost:5901
#    Firefox:  vnc://localhost:5902
#    Edge:     vnc://localhost:5903
#
# 6. Debug with noVNC (browser):
#    Chrome 1: http://localhost:7900
#    Chrome 2: http://localhost:7901
#    Firefox:  http://localhost:7902
#    Edge:     http://localhost:7903
#
# 7. Stop all:
#    docker-compose down
#
# 8. Clean up everything:
#    docker-compose down -v --remove-orphans
